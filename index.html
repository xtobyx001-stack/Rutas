<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Llega Ya | Elite Est√°tico</title>
    <style>
        :root { --bg: #020617; --card: #1e293b; --blue: #3b82f6; --green: #10b981; --orange: #f59e0b; --red: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); color: white; padding-bottom: 100px; overflow-x: hidden; }
        
        header { background: var(--card); padding: 15px; text-align: center; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
        .stats { display: flex; justify-content: space-around; padding: 10px; background: #0f172a; font-size: 0.9rem; font-weight: bold; }

        #list { padding: 10px; }
        .card { background: var(--card); margin-bottom: 15px; padding: 15px; border-radius: 15px; border-left: 5px solid var(--blue); transition: opacity 0.3s; }
        .card.done { border-left-color: var(--green); opacity: 0.6; }
        
        .btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; color: white; cursor: pointer; margin-bottom: 8px; display: block; text-align: center; text-decoration: none; font-size: 0.9rem; }
        .btn-upd { background: var(--orange); color: black; }
        .btn-paste { background: #6366f1; }
        .btn-maps { background: var(--blue); }
        .btn-wa { background: #25d366; }
        
        .row { display: flex; gap: 8px; }
        .btn-s { flex: 1; padding: 12px; border-radius: 8px; border: none; color: white; font-weight: bold; }

        /* Modal que no rompe la vista */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; padding: 25px; z-index: 1000; justify-content: center; backdrop-filter: blur(5px); }
        input, textarea { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 1rem; }

        .float { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 99; }
        .circle { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<header><h1>LLEGA YA ELITE üõµ</h1></header>
<div class="stats">
    <div>LISTO: <span id="count">0/0</span></div>
    <div>DINERO: <span id="cash">RD$ 0</span></div>
</div>

<div id="list"></div>

<div class="float">
    <button class="circle" style="background: var(--green)" onclick="showM('addM')">+</button>
    <button class="circle" style="background: var(--blue)" onclick="showM('cfgM')">‚öôÔ∏è</button>
</div>

<div id="pasteM" class="modal">
    <h2 style="color:var(--orange); margin-bottom:10px;">Actualizar Destino</h2>
    <p style="margin-bottom:15px; opacity:0.8;">Pega aqu√≠ el link de Google Maps o las coordenadas (ej: 18.4, -69.9):</p>
    <textarea id="coordsInput" rows="4" placeholder="Pega el link de WhatsApp aqu√≠..."></textarea>
    <input type="hidden" id="targetId">
    <button class="btn" style="background:var(--green)" onclick="saveManualLocation()">ACTUALIZAR CLIENTE</button>
    <button class="btn" style="background:var(--red)" onclick="hideM()">CANCELAR</button>
</div>

<div id="addM" class="modal">
    <h2>Nuevo Pedido</h2><br>
    <input type="text" id="n" placeholder="Nombre">
    <input type="tel" id="t" placeholder="WhatsApp">
    <input type="number" id="m" placeholder="Monto RD$">
    <button class="btn" style="background:var(--green)" onclick="add()">GUARDAR</button>
    <button class="btn" style="background:var(--red)" onclick="hideM()">CERRAR</button>
</div>

<div id="cfgM" class="modal">
    <h2>Configuraci√≥n</h2><br>
    <button class="btn btn-maps" onclick="document.getElementById('file').click()">üìÇ CARGAR JSON</button>
    <button class="btn" style="background:var(--red)" onclick="if(confirm('¬øBorrar todo?')){localStorage.clear(); location.reload();}">üóëÔ∏è LIMPIAR TODO</button>
    <button class="btn" style="background:var(--card)" onclick="hideM()">CERRAR</button>
</div>

<input type="file" id="file" style="display:none" accept=".json">

<script>
    let db = JSON.parse(localStorage.getItem('ly_v11')) || [];
    let curPos = { lat: 0, lng: 0 };

    // GPS en segundo plano, sin molestar
    navigator.geolocation.watchPosition(p => {
        curPos = { lat: p.coords.latitude, lng: p.coords.longitude };
    }, null, { enableHighAccuracy: true });

    function render() {
        const div = document.getElementById('list');
        div.innerHTML = ''; // Solo se llama al cargar o al borrar/a√±adir
        db.forEach((c, i) => {
            const card = document.createElement('div');
            card.id = `card-${i}`;
            card.className = `card ${c.s === 'ok' ? 'done' : ''}`;
            card.innerHTML = `
                <h3>${c.n}</h3>
                <p>RD$ ${Number(c.m).toLocaleString()} | ${c.t}</p>
                
                <div class="row" style="margin-bottom:8px">
                    <button class="btn-upd" style="flex:1" onclick="updGPS(${i})">üìç USAR MI GPS</button>
                    <button class="btn-paste" style="flex:1" onclick="openPastePanel(${i})">üìã PEGAR LINK</button>
                </div>
                
                <a id="link-${i}" class="btn btn-maps" href="https://www.google.com/maps/dir/?api=1&destination=${c.lt},${c.lg}&travelmode=motorcycle" target="_blank">üöÄ IR AL MAPA</a>
                <a class="btn btn-wa" href="https://wa.me/${c.t}" target="_blank">üí¨ WHATSAPP</a>
                
                <div class="row">
                    <button class="btn-s" style="background:var(--green)" onclick="status(${i},'ok')">OK</button>
                    <button class="btn-s" style="background:var(--red)" onclick="status(${i},'no')">NO</button>
                </div>
            `;
            div.appendChild(card);
        });
        updateStats();
    }

    // ACTUALIZAR SIN RECARGAR P√ÅGINA
    function updGPS(i) {
        if(curPos.lat === 0) return alert("Esperando se√±al GPS...");
        db[i].lt = curPos.lat;
        db[i].lg = curPos.lng;
        silenceSave();
        document.getElementById(`link-${i}`).href = `https://www.google.com/maps/dir/?api=1&destination=${db[i].lt},${db[i].lg}&travelmode=motorcycle`;
        alert("üìç Ubicaci√≥n actualizada a tu posici√≥n actual.");
    }

    function openPastePanel(i) {
        document.getElementById('targetId').value = i;
        document.getElementById('coordsInput').value = '';
        showM('pasteM');
    }

    function saveManualLocation() {
        const i = document.getElementById('targetId').value;
        const text = document.getElementById('coordsInput').value;
        
        // Extraer coordenadas de links o texto plano
        const reg = /(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)/;
        const match = text.match(reg);
        
        if (match) {
            db[i].lt = match[1];
            db[i].lg = match[2];
            silenceSave();
            document.getElementById(`link-${i}`).href = `https://www.google.com/maps/dir/?api=1&destination=${db[i].lt},${db[i].lg}&travelmode=motorcycle`;
            hideM();
            alert("‚úÖ Ubicaci√≥n actualizada con √©xito.");
        } else {
            alert("No encontr√© coordenadas. Pega el link de Google Maps o las coordenadas (ej: 18.44, -69.95)");
        }
    }

    function status(i, s) { 
        db[i].s = s; 
        silenceSave();
        document.getElementById(`card-${i}`).className = `card ${s === 'ok' ? 'done' : ''}`;
        updateStats();
    }

    function silenceSave() { localStorage.setItem('ly_v11', JSON.stringify(db)); }

    function add() {
        const nom = document.getElementById('n').value;
        if(!nom) return;
        db.push({ n: nom, t: document.getElementById('t').value, m: document.getElementById('m').value, lt: curPos.lat, lg: curPos.lng, s: 'p' });
        localStorage.setItem('ly_v11', JSON.stringify(db));
        render(); hideM();
    }

    function updateStats() {
        const ok = db.filter(x => x.s === 'ok');
        document.getElementById('count').innerText = `${ok.length}/${db.length}`;
        document.getElementById('cash').innerText = `RD$ ${ok.reduce((a, b) => a + Number(b.m || 0), 0).toLocaleString()}`;
    }

    function showM(id) { document.getElementById(id).style.display = 'flex'; }
    function hideM() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    document.getElementById('file').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = ev => { db = JSON.parse(ev.target.result).clientes || JSON.parse(ev.target.result); localStorage.setItem('ly_v11', JSON.stringify(db)); render(); hideM(); };
        reader.readAsText(e.target.files[0]);
    });

    render();
</script>
</body>
</html>
