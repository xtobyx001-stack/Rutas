<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Llega Ya | Sistema de Flota Full</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --red: #E60042; --blue: #007AFF; --green: #28a745; --bg: #F2F2F7; }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); font-family: 'Outfit', sans-serif; padding-bottom: 120px; }
        
        header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 800; color: var(--red); font-size: 1.3rem; cursor: pointer; }
        #gps-status { font-size: 0.7rem; color: var(--green); font-weight: 700; margin-top: 5px; }

        /* PANEL DEL JEFE */
        #admin-panel { display: none; background: #1c1c1e; color: white; padding: 20px; margin: 15px; border-radius: 20px; border: 2px solid var(--red); }
        textarea { width: 100%; background: #000; color: #0f0; border: 1px solid #333; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-family: monospace; }
        
        /* FORMULARIO AGREGAR CLIENTE (MENSAJERO) */
        #add-client-form { display: none; background: white; margin: 15px; padding: 20px; border-radius: 24px; border: 2px solid var(--blue); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #DDD; font-family: 'Outfit', sans-serif; }

        /* TARJETAS */
        .card { background: white; margin: 15px; padding: 20px; border-radius: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #EEE; }
        .card.done { opacity: 0.5; filter: grayscale(1); }
        .client-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; display: block; }
        .info { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        .price { font-weight: 800; color: var(--green); background: #EFFFF4; padding: 2px 6px; border-radius: 5px; }

        /* BOTONES */
        .btn-nav { background: var(--blue); color: white; width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 800; font-size: 1rem; margin-bottom: 12px; }
        .btn-no-loc { background: #EEE; color: #888; width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 800; margin-bottom: 12px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-action { padding: 14px; border-radius: 14px; border: none; font-weight: 700; font-size: 0.85rem; }
        .btn-reubicar { background: #FFF0F4; color: var(--red); }
        .btn-wa { background: #25D366; color: white; }
        .btn-entregado { background: var(--red); color: white; width: 100%; padding: 16px; margin-top: 12px; border-radius: 14px; border: none; font-weight: 800; }

        /* BOT√ìN FLOTANTE AGREGAR */
        .fab { position: fixed; bottom: 30px; right: 20px; background: var(--blue); color: white; width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 10px 20px rgba(0,122,255,0.4); border: none; z-index: 99; font-weight: 800; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="abrirAdmin()">LLEGA YA ELITE üõµ</div>
    <div id="gps-status">üõ∞Ô∏è GPS ACTIVO</div>
</header>

<button class="fab" onclick="toggleAddForm()">+</button>

<div id="admin-panel">
    <div style="text-align:center; color:var(--red); font-weight:800; margin-bottom:10px;">PANEL DEL DUE√ëO</div>
    <input type="file" id="file-input" accept=".json" style="margin-bottom: 10px; font-size: 0.8rem; color: white;">
    <textarea id="json-box" rows="3" placeholder="Pegar c√≥digo..."></textarea>
    <button onclick="generarLinkWorker()" style="background:var(--green); color:white; width:100%; padding:12px; border-radius:10px; border:none; font-weight:800;">GENERAR LINK</button>
    <div id="link-res" style="display:none; background:#000; color:#0f0; padding:10px; border-radius:10px; font-size:0.6rem; word-break:break-all; margin-top:10px;"></div>
    <button onclick="cerrarAdmin()" style="width:100%; background:none; color:white; margin-top:10px; border:1px solid #444; padding:5px; border-radius:8px;">Cerrar</button>
</div>

<div id="add-client-form">
    <div style="font-weight:800; margin-bottom:15px; color:var(--blue);">NUEVO CLIENTE / PEDIDO</div>
    <div class="input-group"><label>NOMBRE:</label><input type="text" id="new-name" placeholder="Ej: Juan P√©rez"></div>
    <div class="input-group"><label>TEL√âFONO:</label><input type="tel" id="new-phone" placeholder="8090000000"></div>
    <div class="input-group"><label>MONTO A COBRAR (RD$):</label><input type="number" id="new-cod" placeholder="0.00"></div>
    <div style="font-size: 0.7rem; color: #666; margin-bottom: 15px;">* Se guardar√° con tu ubicaci√≥n GPS actual autom√°ticamente.</div>
    <button onclick="saveNewClient()" style="background:var(--blue); color:white; width:100%; padding:15px; border-radius:12px; border:none; font-weight:800;">GUARDAR CLIENTE</button>
    <button onclick="toggleAddForm()" style="width:100%; background:none; color:#999; margin-top:10px; border:none; font-weight:700;">CANCELAR</button>
</div>

<div id="lista-pedidos"></div>

<script>
    let db = { clientes: [] };
    let miLoc = { lat: 0, lng: 0 };

    function init() {
        const params = new URLSearchParams(window.location.search);
        const rutaUrl = params.get('ruta');
        if (rutaUrl) {
            try {
                const decodificado = JSON.parse(decodeURIComponent(atob(rutaUrl)));
                db.clientes = [...(decodificado.clientes || []), ...(decodificado.sin_ubicacion || [])];
                guardar();
                window.history.replaceState({}, document.title, window.location.pathname);
            } catch(e) { console.log(e); }
        } else {
            const guardado = localStorage.getItem('ly_pro_v7');
            if(guardado) db = JSON.parse(guardado);
        }

        document.getElementById('file-input').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(e) { document.getElementById('json-box').value = e.target.result; };
            reader.readAsText(e.target.files[0]);
        });

        navigator.geolocation.watchPosition(p => {
            miLoc = { lat: p.coords.latitude, lng: p.coords.longitude };
            render();
        }, null, {enableHighAccuracy:true});
        render();
    }

    function render() {
        const cont = document.getElementById('lista-pedidos');
        if(!db.clientes.length) {
            cont.innerHTML = '<p style="text-align:center;padding:100px 20px;color:#888;">Toca el logo arriba o el bot√≥n "+" para empezar.</p>';
            return;
        }
        const lista = db.clientes.sort((a,b) => (a.estado === 'entregado' ? 1 : -1));
        let html = '';
        lista.forEach(c => {
            const entregado = c.estado === 'entregado';
            const tieneLoc = (c.lat && c.lat != "0");
            html += `
            <div class="card ${entregado ? 'done' : ''}">
                <span class="client-name">${c.nombre}</span>
                <div class="info">Tel: ${c.telefono} | <span class="price">RD$ ${c.cod}</span></div>
                ${tieneLoc ? `<button class="btn-nav" onclick="irMapa('${c.lat}', '${c.lng}')">üöÄ IR AL MAPA</button>` : `<button class="btn-no-loc" onclick="reubicar(${c.id})">‚ö†Ô∏è SIN UBICACI√ìN (A√ëADIR)</button>`}
                <div class="grid"><button class="btn-action btn-reubicar" onclick="reubicar(${c.id})">üìç MOVER</button><button class="btn-action btn-wa" onclick="window.open('https://wa.me/${c.telefono}')">WHATSAPP</button></div>
                <button class="btn-entregado" onclick="marcar(${c.id})">${entregado ? '‚úì ENTREGADO' : 'MARCAR ENTREGADO'}</button>
            </div>`;
        });
        cont.innerHTML = html;
    }

    // --- FUNCI√ìN AGREGAR MANUAL (TRABAJADOR) ---
    function toggleAddForm() {
        const form = document.getElementById('add-client-form');
        form.style.display = form.style.display === 'block' ? 'none' : 'block';
        if(form.style.display === 'block') window.scrollTo(0,0);
    }

    function saveNewClient() {
        const name = document.getElementById('new-name').value;
        const phone = document.getElementById('new-phone').value;
        const cod = document.getElementById('new-cod').value;

        if(!name || !phone) return alert("Nombre y Tel√©fono son obligatorios");
        if(!miLoc.lat) return alert("Esperando se√±al GPS para fijar al cliente...");

        const nuevo = {
            id: Date.now(),
            nombre: name,
            telefono: phone,
            cod: cod || "0",
            lat: miLoc.lat,
            lng: miLoc.lng,
            estado: 'pendiente'
        };

        db.clientes.unshift(nuevo);
        guardar();
        toggleAddForm();
        // Limpiar campos
        document.getElementById('new-name').value = "";
        document.getElementById('new-phone').value = "";
        document.getElementById('new-cod').value = "";
    }

    function irMapa(lat, lng) { window.open(`https://www.google.com/maps/dir/?api=1&destination=$0{lat},${lng}&travelmode=motorcycle`); }
    function reubicar(id) {
        const c = db.clientes.find(x => x.id == id);
        if(confirm("¬øFijar este cliente en tu posici√≥n actual?")) {
            c.lat = miLoc.lat; c.lng = miLoc.lng; guardar();
        }
    }
    function marcar(id) { db.clientes.find(x => x.id == id).estado = 'entregado'; guardar(); }
    function guardar() { localStorage.setItem('ly_pro_v7', JSON.stringify(db)); render(); }
    function abrirAdmin() { if(prompt("CLAVE:") === "1234") document.getElementById('admin-panel').style.display = 'block'; }
    function cerrarAdmin() { document.getElementById('admin-panel').style.display = 'none'; }
    function generarLinkWorker() {
        const txt = document.getElementById('json-box').value;
        const b64 = btoa(encodeURIComponent(txt));
        const link = `${window.location.href.split('?')[0]}?ruta=${b64}`;
        const res = document.getElementById('link-res');
        res.style.display = 'block';
        res.innerHTML = `<strong>LINK:</strong><br>${link}<br><br><button onclick="navigator.clipboard.writeText('${link}');alert('Copiado')">COPIAR</button>`;
    }

    init();
</script>
</body>
</html>
