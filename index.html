<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Llega Ya | Mensajer√≠a Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --peya-red: #E60042; /* Rojo PedidosYa */
            --didi-orange: #FF8D4D; /* Naranja DiDi */
            --bg-gray: #F7F7F7;
            --text-dark: #2D2D2D;
            --text-light: #757575;
            --white: #FFFFFF;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        
        body { 
            background-color: var(--bg-gray); 
            color: var(--text-dark); 
            font-family: 'Outfit', sans-serif; 
            padding-bottom: 100px;
        }

        /* Header Estilo App */
        header { 
            background: var(--white); 
            padding: 15px 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-weight: 700; font-size: 1.2rem; color: var(--peya-red); letter-spacing: -0.5px; }
        #gps-status { font-size: 0.7rem; color: #10b981; font-weight: 600; margin-top: 4px; display: flex; align-items: center; gap: 4px; }
        #gps-status::before { content: '‚óè'; font-size: 10px; animation: blink 1s infinite; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* Dashboard de Ingresos */
        .stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            padding: 15px; 
        }
        .kpi { 
            background: var(--white); 
            padding: 15px; 
            border-radius: 16px; 
            box-shadow: var(--shadow);
            border: 1px solid #EAEAEA;
        }
        .kpi span { font-size: 0.7rem; color: var(--text-light); font-weight: 600; text-transform: uppercase; }
        .kpi b { display: block; font-size: 1.1rem; color: var(--text-dark); margin-top: 2px; }

        /* Tarjetas de Clientes Estilo PedidosYa */
        .card { 
            background: var(--white); 
            margin: 0 15px 15px; 
            padding: 18px; 
            border-radius: 20px; 
            box-shadow: var(--shadow);
            border: 1px solid #EAEAEA;
            position: relative;
            overflow: hidden;
        }
        .card.done { opacity: 0.6; filter: grayscale(1); background: #f0f0f0; }

        .dist-tag {
            background: #FFF0F4;
            color: var(--peya-red);
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 8px;
            display: inline-block;
            margin-bottom: 10px;
        }

        .client-name { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); margin-bottom: 4px; }
        .client-info { font-size: 0.85rem; color: var(--text-light); margin-bottom: 15px; }
        .client-cod { font-weight: 700; color: #28a745; background: #EFFFF4; padding: 2px 6px; border-radius: 4px; }

        /* Botones de Acci√≥n */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        button { 
            border-radius: 12px; 
            border: none; 
            font-family: 'Outfit', sans-serif; 
            font-weight: 700; 
            font-size: 0.85rem; 
            cursor: pointer; 
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-maps { background: #E8F2FF; color: #007AFF; padding: 12px; width: 100%; margin-bottom: 10px; }
        .btn-wa { background: #EFFFF4; color: #28a745; padding: 12px; }
        .btn-move { background: #FFF4E8; color: var(--didi-orange); padding: 12px; }
        
        /* Botones de Estado */
        .status-group { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }
        .btn-ok { background: var(--peya-red); color: white; padding: 14px; }
        .btn-reset { background: #F2F2F2; color: var(--text-dark); padding: 14px; }

        /* Barra Inferior (Dock) */
        .dock {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            padding: 15px 25px 30px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05);
            border-top: 1px solid #EAEAEA;
            z-index: 1000;
        }
        .dock-item { color: var(--text-light); font-size: 1.5rem; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .dock-item.active { color: var(--peya-red); }
        .dock-item span { font-size: 0.6rem; font-weight: 700; }

        /* Modal Moderno */
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
            display: none; align-items: center; justify-content: center; 
            z-index: 2000; padding: 20px; backdrop-filter: blur(4px);
        }
        .modal-content { 
            background: var(--white); padding: 25px; border-radius: 24px; 
            width: 100%; max-width: 340px; text-align: center;
        }
        textarea { 
            width: 100%; padding: 15px; border-radius: 12px; border: 1px solid #DDD; 
            margin: 15px 0; font-family: inherit; font-size: 1rem; background: #F9F9F9;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">LLEGA YA üõµ</div>
    <div id="gps-status">GPS CONECTADO</div>
</header>

<div class="stats">
    <div class="kpi"><span>Entregas</span><b id="count">0/0</b></div>
    <div class="kpi"><span>Por Cobrar</span><b id="cash">RD$ 0</b></div>
</div>

<div id="list"></div>

<div class="dock">
    <div class="dock-item active" onclick="location.reload()">üìç<span>Ruta</span></div>
    <div class="dock-item" onclick="openM('m-js')" style="color:var(--didi-orange)">üìù<span>Cargar</span></div>
    <div class="dock-item" onclick="resetApp()" style="color:var(--text-light)">üóëÔ∏è<span>Limpiar</span></div>
</div>

<div id="m-js" class="modal">
    <div class="modal-content">
        <h3>Nueva Ruta</h3>
        <p style="font-size:0.8rem; color:var(--text-light)">Pega el c√≥digo JSON de tus clientes</p>
        <textarea id="t-js" rows="6" placeholder="Pega aqu√≠..."></textarea>
        <button class="btn-ok" style="width:100%" onclick="importData()">EMPEZAR RUTA</button>
        <button class="btn-reset" style="width:100%; margin-top:10px" onclick="closeM()">Cerrar</button>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('ly_delivery_v1')) || { clientes: [], sin_ubicacion: [] };
    let myLoc = { lat: 0, lng: 0 };

    function init() {
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                myLoc = { lat: p.coords.latitude, lng: p.coords.longitude };
                render();
            }, null, {enableHighAccuracy:true});
        }
        render();
    }

    function getD(l1, n1, l2, n2) {
        if(!l1 || !l2) return 999;
        const R = 6371;
        const dL = (l2-l1)*Math.PI/180; const dN = (n2-n1)*Math.PI/180;
        const a = Math.sin(dL/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dN/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function render() {
        const box = document.getElementById('list');
        const todos = [...db.clientes, ...db.sin_ubicacion];
        if(!todos.length) { box.innerHTML = '<div style="text-align:center;padding:50px;color:#AAA">No hay pedidos asignados</div>'; return; }

        const orden = todos.sort((a,b) => {
            if (a.estado === 'entregado') return 1;
            if (b.estado === 'entregado') return -1;
            return getD(myLoc.lat, myLoc.lng, a.lat, a.lng) - getD(myLoc.lat, myLoc.lng, b.lat, b.lng);
        });

        let h = '';
        orden.forEach(c => {
            const dist = getD(myLoc.lat, myLoc.lng, c.lat, c.lng);
            const isDone = c.estado === 'entregado';
            h += `
            <div class="card ${isDone ? 'done' : ''}">
                <div class="dist-tag">${c.lat ? 'A ' + dist.toFixed(2) + ' km' : 'UBICACI√ìN POR CONFIRMAR'}</div>
                <div class="client-name">${c.nombre}</div>
                <div class="client-info">Tel: ${c.telefono} | <span class="client-cod">RD$ ${Number(c.cod).toLocaleString()}</span></div>
                
                ${c.lat ? `<button class="btn-maps" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}&travelmode=motorcycle')">üìç VER MAPA</button>` : ''}
                
                <div class="btn-group">
                    <button class="btn-move" onclick="reubicar(${c.id})">üîÑ MOVER</button>
                    <button class="btn-wa" onclick="window.open('https://wa.me/${c.telefono}')">WHATSAPP</button>
                </div>
                
                <div class="status-group">
                    <button class="btn-ok" onclick="setStatus(${c.id},'entregado')">ENTREGADO</button>
                    <button class="btn-reset" onclick="setStatus(${c.id},'pendiente')">‚Ü©</button>
                </div>
            </div>`;
        });
        box.innerHTML = h;
        updateStats(todos);
    }

    function reubicar(id) {
        const op = confirm("¬øEl cliente cambi√≥ de lugar?\n\nOK: Guardar donde est√°s t√∫ ahora.\nCANCELAR: Pegar coordenadas de WhatsApp.");
        if(op) {
            if(!myLoc.lat) return alert("Esperando GPS...");
            updateCoords(id, myLoc.lat, myLoc.lng);
        } else {
            const raw = prompt("Pega las coordenadas (ej: 19.3, -70.2):");
            if(raw && raw.includes(',')) {
                const p = raw.split(',');
                updateCoords(id, parseFloat(p[0]), parseFloat(p[1]));
            }
        }
    }

    function updateCoords(id, lat, lng) {
        let c = db.clientes.find(x => x.id == id) || db.sin_ubicacion.find(x => x.id == id);
        if(db.sin_ubicacion.find(x => x.id == id)) {
            let i = db.sin_ubicacion.findIndex(x => x.id == id);
            c = db.sin_ubicacion.splice(i, 1)[0];
            db.clientes.push(c);
        }
        c.lat = lat; c.lng = lng;
        save();
        alert("¬°Ubicaci√≥n actualizada!");
    }

    function setStatus(id, s) { [...db.clientes, ...db.sin_ubicacion].forEach(c => {if(c.id==id) c.estado=s;}); save(); }
    function updateStats(t) {
        const ok = t.filter(x => x.estado === 'entregado');
        document.getElementById('count').innerText = `${ok.length}/${t.length}`;
        document.getElementById('cash').innerText = `RD$ ${ok.reduce((a,b)=>a+(Number(b.cod)||0),0).toLocaleString()}`;
    }
    function importData() { try { const j = JSON.parse(document.getElementById('t-js').value); db = {clientes:j.clientes||[], sin_ubicacion:j.sin_ubicacion||[]}; save(); closeM(); } catch(e){alert("Error JSON");} }
    function save() { localStorage.setItem('ly_delivery_v1', JSON.stringify(db)); render(); }
    function openM(id) { document.getElementById(id).style.display = 'flex'; }
    function closeM() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function resetApp() { if(confirm('¬øLimpiar ruta?')) { localStorage.removeItem('ly_delivery_v1'); location.reload(); } }

    init();
</script>
</body>
</html>
