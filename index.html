<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LLEGA YA üõµ</title>
<style>
  :root { --bg: #0f172a; --card: #1e293b; --blue: #3b82f6; --green: #10b981; --orange: #f59e0b; --red: #ef4444; --purple: #8b5cf6; --border: #334155; }
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
  body { background: var(--bg); color: #f1f5f9; min-height: 100vh; padding-bottom: 80px; }

header { background: var(‚Äìcard); padding: 14px 16px; border-bottom: 1px solid var(‚Äìborder); position: sticky; top: 0; z-index: 50; display: flex; align-items: center; justify-content: space-between; }
header h1 { font-size: 1.1rem; }
.stats { font-size: 0.75rem; color: #94a3b8; }

.toolbar { display: flex; gap: 8px; padding: 10px; background: #0f172a; border-bottom: 1px solid var(‚Äìborder); position: sticky; top: 53px; z-index: 49; }
.toolbar button { flex: 1; padding: 10px 6px; border-radius: 8px; border: none; font-weight: bold; font-size: 0.8rem; cursor: pointer; color: white; }

.search-bar { padding: 8px 10px; background: #0f172a; border-bottom: 1px solid var(‚Äìborder); position: sticky; top: 106px; z-index: 48; }
.search-bar input { width: 100%; padding: 10px 14px 10px 36px; border-radius: 8px; border: 1px solid var(‚Äìborder); background: var(‚Äìcard); color: #f1f5f9; font-size: 0.9rem; }
.search-bar input::placeholder { color: #64748b; }
.search-wrap { position: relative; }
.search-wrap .lupa { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 1rem; pointer-events: none; }

.tabs { display: flex; border-bottom: 1px solid var(‚Äìborder); background: var(‚Äìcard); position: sticky; top: 159px; z-index: 47; }
.tab { flex: 1; padding: 10px; text-align: center; font-size: 0.85rem; font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; color: #94a3b8; }
.tab.active { color: var(‚Äìblue); border-bottom-color: var(‚Äìblue); }

#list { padding: 10px; }

.card { background: var(‚Äìcard); border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(‚Äìblue); overflow: hidden; }
.card.entregado { border-left-color: var(‚Äìgreen); opacity: 0.6; }
.card.fallido { border-left-color: var(‚Äìred); opacity: 0.6; }
.card.sin-ubi.entregado { border-left-color: var(‚Äìgreen); opacity: 0.4; }
.card.sin-ubi.fallido { border-left-color: var(‚Äìred); opacity: 0.4; }
.card.sin-ubi { border-left-color: var(‚Äìorange); }

.card-header { padding: 12px 14px 4px; }
.card-header .nombre { font-weight: bold; font-size: 1rem; }
.card-header .cod { font-size: 0.8rem; color: #94a3b8; margin-top: 2px; }

.card-body { padding: 8px 14px 12px; display: flex; flex-direction: column; gap: 6px; }
.btn-row { display: flex; gap: 6px; }
.btn { padding: 10px; border-radius: 8px; border: none; font-weight: bold; font-size: 0.82rem; cursor: pointer; color: white; text-align: center; text-decoration: none; display: block; width: 100%; }
.btn-sm { flex: 1; padding: 9px 4px; border-radius: 8px; border: none; font-weight: bold; font-size: 0.78rem; cursor: pointer; color: white; }

.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; display: none; align-items: center; justify-content: center; padding: 20px; }
.overlay.open { display: flex; }
.modal { background: var(‚Äìcard); border-radius: 16px; padding: 24px; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
.modal h2 { margin-bottom: 16px; font-size: 1.1rem; }
.field { margin-bottom: 12px; }
.field label { display: block; font-size: 0.8rem; color: #94a3b8; margin-bottom: 4px; }
.field input, .field textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(‚Äìborder); background: #0f172a; color: white; font-size: 0.95rem; }
.field textarea { resize: vertical; min-height: 80px; }
.modal-btns { display: flex; gap: 8px; margin-top: 16px; }
.modal-btns button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; font-size: 0.9rem; }

.fab { position: fixed; bottom: 20px; right: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 49; }
.fab button { width: 56px; height: 56px; border-radius: 50%; border: none; font-size: 1.5rem; cursor: pointer; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }

.badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; margin-left: 6px; }
.badge-orange { background: var(‚Äìorange); color: black; }

.empty { text-align: center; padding: 40px 20px; color: #64748b; }
</style>

</head>
<body>

<header>
  <h1>üõµ LLEGA YA</h1>
  <span class="stats" id="stats"></span>
</header>

<div class="toolbar">
  <button style="background:var(--blue)" onclick="openModal('modalCargar')">üìÇ Cargar JSON</button>
  <button style="background:var(--purple)" onclick="sortNearest()">‚ö° Cercan√≠a</button>
  <button style="background:var(--green)" onclick="openModal('modalCliente')">+ Cliente</button>
</div>

<div class="search-bar">
  <div class="search-wrap">
    <span class="lupa">üîç</span>
    <input type="text" id="busqueda" placeholder="Buscar por nombre o tel√©fono..." oninput="render()">
  </div>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('pendientes')">Pendientes</div>
  <div class="tab" onclick="switchTab('sin_ubicacion')">Sin Ubicaci√≥n</div>
  <div class="tab" onclick="switchTab('completados')">Completados</div>
</div>

<div id="list"></div>

<!-- Modal Cargar JSON -->

<div class="overlay" id="modalCargar">
  <div class="modal">
    <h2>üìÇ Cargar Archivo JSON</h2>
    <div class="field">
      <label>Selecciona tu archivo .json</label>
      <input type="file" id="fileInput" accept=".json" onchange="cargarArchivo(event)">
    </div>
    <div class="field">
      <label>O pega el contenido JSON aqu√≠</label>
      <textarea id="jsonPaste" placeholder='{ "clientes": [...] }'></textarea>
    </div>
    <div class="modal-btns">
      <button style="background:var(--green)" onclick="cargarPegado()">CARGAR</button>
      <button style="background:var(--border)" onclick="closeModal('modalCargar')">CANCELAR</button>
    </div>
  </div>
</div>

<!-- Modal Nuevo/Editar Cliente -->

<div class="overlay" id="modalCliente">
  <div class="modal">
    <h2 id="modalClienteTitulo">‚ûï Nuevo Cliente</h2>
    <input type="hidden" id="editId">
    <div class="field"><label>Nombre</label><input type="text" id="cNombre" placeholder="Nombre completo"></div>
    <div class="field"><label>Tel√©fono / WhatsApp</label><input type="tel" id="cTel" placeholder="18091234567"></div>
    <div class="field"><label>Monto (RD$)</label><input type="number" id="cCod" placeholder="0"></div>
    <div class="field"><label>Latitud</label><input type="text" id="cLat" placeholder="19.2917"></div>
    <div class="field"><label>Longitud</label><input type="text" id="cLng" placeholder="-70.2558"></div>
    <div class="modal-btns">
      <button style="background:var(--green)" onclick="guardarCliente()">GUARDAR</button>
      <button style="background:var(--border)" onclick="closeModal('modalCliente')">CANCELAR</button>
    </div>
  </div>
</div>

<!-- Modal Actualizar Ubicaci√≥n -->

<div class="overlay" id="modalUbi">
  <div class="modal">
    <h2>üìç Actualizar Ubicaci√≥n</h2>
    <input type="hidden" id="ubiId">
    <p style="font-size:0.85rem;color:#94a3b8;margin-bottom:12px;">Pega las coordenadas o un link de Google Maps</p>
    <div class="field"><textarea id="ubiInput" placeholder="19.2917, -70.2558&#10;o&#10;https://maps.google.com/?q=19.2917,-70.2558"></textarea></div>
    <div class="modal-btns">
      <button style="background:var(--green)" onclick="guardarUbicacion()">GUARDAR</button>
      <button style="background:var(--border)" onclick="closeModal('modalUbi')">CANCELAR</button>
    </div>
  </div>
</div>

<!-- FAB + Config -->

<div class="fab">
  <button style="background:#475569" onclick="openModal('modalConfig')">‚öôÔ∏è</button>
</div>

<div class="overlay" id="modalConfig">
  <div class="modal">
    <h2>‚öôÔ∏è Opciones</h2>
    <br>
    <button class="btn" style="background:var(--red)" onclick="if(confirm('¬øBorrar todos los clientes? Esto no se puede deshacer.')){localStorage.removeItem('llega_ya_clientes');clientes=[];guardar();closeModal('modalConfig');}">üóëÔ∏è Borrar Todo (fin del d√≠a)</button>
    <button class="btn" style="background:#475569;margin-top:8px" onclick="closeModal('modalConfig')">CERRAR</button>
  </div>
</div>

<script>
let clientes = JSON.parse(localStorage.getItem('llega_ya_clientes') || '[]');
let tabActual = 'pendientes';
const ORIGEN = { lat: 19.2917, lng: -70.2558 };

function guardar() {
  localStorage.setItem('llega_ya_clientes', JSON.stringify(clientes));
  render();
}

function render() {
  const list = document.getElementById('list');
  const busqueda = document.getElementById('busqueda').value.toLowerCase().trim();
  let datos;

  if (tabActual === 'pendientes') {
    datos = clientes.filter(c => c.estado === 'pendiente' && c.lat && c.lng);
  } else if (tabActual === 'sin_ubicacion') {
    datos = clientes.filter(c => !c.lat || !c.lng);
  } else {
    datos = clientes.filter(c => (c.estado === 'entregado' || c.estado === 'fallido') && c.lat && c.lng);
  }


  if (busqueda) {
    datos = datos.filter(c =>
      (c.nombre || '').toLowerCase().includes(busqueda) ||
      (c.telefono || '').includes(busqueda)
    );
  }

  const total = clientes.length;
  const entregados = clientes.filter(c => c.estado === 'entregado').length;
  document.getElementById('stats').textContent = `${entregados}/${total} entregados`;

  if (datos.length === 0) {
    list.innerHTML = '<div class="empty">No hay clientes en esta secci√≥n</div>';
    return;
  }

  list.innerHTML = datos.map(c => {
    const mapsUrl = c.lat && c.lng ? `https://www.google.com/maps?q=${c.lat},${c.lng}` : null;
    const waUrl = c.telefono ? `https://wa.me/${c.telefono.replace(/\D/g,'')}` : null;
    const sinUbi = !c.lat || !c.lng;
    const esSinUbi = tabActual === 'sin_ubicacion';

    // Estado visual de los botones toggle
    const btnEntregado = c.estado === 'entregado'
      ? `<button class="btn-sm" style="background:#065f46" onclick="toggleEstado(${c.id},'entregado','pendiente')">‚úÖ Entregado</button>`
      : `<button class="btn-sm" style="background:var(--green)" onclick="toggleEstado(${c.id},'pendiente','entregado')">‚úÖ Entregado</button>`;

    const btnFallo = c.estado === 'fallido'
      ? `<button class="btn-sm" style="background:#7f1d1d" onclick="toggleEstado(${c.id},'fallido','pendiente')">‚ùå Fall√≥</button>`
      : `<button class="btn-sm" style="background:var(--red)" onclick="toggleEstado(${c.id},'pendiente','fallido')">‚ùå Fall√≥</button>`;

    return `
    <div class="card ${sinUbi ? 'sin-ubi' : ''} ${c.estado !== 'pendiente' ? c.estado : ''}">
      <div class="card-header">
        <div class="nombre">${c.nombre || 'Sin nombre'}${sinUbi ? '<span class="badge badge-orange">Sin GPS</span>' : ''}</div>
        <div class="cod">RD$ ${(c.cod||0).toLocaleString()} ¬∑ Tel: ${c.telefono || '‚Äî'}</div>
      </div>
      <div class="card-body">
        <div class="btn-row">
          ${mapsUrl ? `<a class="btn-sm" style="background:var(--blue)" href="${mapsUrl}" target="_blank">üó∫Ô∏è Mapa</a>` : ''}
          ${waUrl ? `<a class="btn-sm" style="background:#25d366" href="${waUrl}" target="_blank">üí¨ WhatsApp</a>` : ''}
        </div>
        <div class="btn-row">
          <button class="btn-sm" style="background:var(--purple)" onclick="abrirUbi(${c.id})">üìç Ubicaci√≥n</button>
          <button class="btn-sm" style="background:#334155" onclick="editarCliente(${c.id})">‚úèÔ∏è Editar</button>
        </div>
        ${esSinUbi ? `
        <div class="btn-row">
          ${btnEntregado}
          ${btnFallo}
        </div>
        <div class="btn-row">
          <button class="btn-sm" style="background:#0f766e" onclick="rotarAlFinal(${c.id})">üîÑ Ya Contact√©</button>
        </div>` : tabActual === 'completados' ? `
        <div class="btn-row">
          ${btnEntregado}
          ${btnFallo}
          <button class="btn-sm" style="background:#475569" onclick="devolverPendiente(${c.id})">‚Ü©Ô∏è Pendiente</button>
        </div>` : `
        <div class="btn-row">
          ${btnEntregado}
          ${btnFallo}
        </div>`}
      </div>
    </div>`;
  }).join('');
}

function switchTab(tab) {
  tabActual = tab;
  document.getElementById('busqueda').value = '';
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', ['pendientes','sin_ubicacion','completados'][i] === tab);
  });
  render();
}

// Toggle de estado: si ya est√° en ese estado, regresa a pendiente
function toggleEstado(id, estadoActual, estadoNuevo) {
  const c = clientes.find(x => x.id === id);
  if (!c) return;
  const sinUbi = !c.lat || !c.lng;
  if (c.estado === estadoNuevo) {
    c.estado = 'pendiente';
  } else {
    c.estado = estadoNuevo;
    if (sinUbi) {
      const idx = clientes.findIndex(x => x.id === id);
      const [removido] = clientes.splice(idx, 1);
      clientes.push(removido);
    }
  }
  guardar();
}

function devolverPendiente(id) {
  const c = clientes.find(x => x.id === id);
  if (c) { c.estado = 'pendiente'; guardar(); }
}

// Rotar al final de la lista (Ya contact√©)
function rotarAlFinal(id) {
  const idx = clientes.findIndex(x => x.id === id);
  if (idx === -1) return;
  const [c] = clientes.splice(idx, 1);
  clientes.push(c);
  guardar();
}

async function sortNearest() {
  const pendientes = clientes.filter(c => c.estado === 'pendiente' && c.lat && c.lng);
  const resto = clientes.filter(c => !(c.estado === 'pendiente' && c.lat && c.lng));

  if (pendientes.length === 0) return alert('No hay clientes con ubicaci√≥n pendientes.');

  const btn = document.querySelector('button[onclick="sortNearest()"]');
  if (btn) { btn.textContent = '‚è≥ Calculando...'; btn.disabled = true; }

  const haversine = (lat1, lng1, lat2, lng2) => {
    const R = 6371, dLat = (lat2-lat1)*Math.PI/180, dLng = (lng2-lng1)*Math.PI/180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  };

  // Obtener ubicaci√≥n actual o usar origen fijo
  let origen = { lat: ORIGEN.lat, lng: ORIGEN.lng };
  try {
    const pos = await new Promise((resolve, reject) => {
      if (!navigator.geolocation) reject('no geo');
      navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
    });
    origen = { lat: pos.coords.latitude, lng: pos.coords.longitude };
  } catch(e) {
    // Si no da permiso o falla, usa el origen fijo
  }

  const haversineFallback = (org) => {
    let lat = org.lat, lng = org.lng;
    let p = [...pendientes], ordenados = [];
    while (p.length > 0) {
      let idx = 0, min = Infinity;
      p.forEach((c, i) => { const d = haversine(lat, lng, c.lat, c.lng); if (d < min) { min = d; idx = i; } });
      const next = p.splice(idx, 1)[0];
      ordenados.push(next); lat = next.lat; lng = next.lng;
    }
    return ordenados;
  };

  let ordenados = null;

  try {
    const coords = [`${origen.lng},${origen.lat}`, ...pendientes.map(c => `${c.lng},${c.lat}`)].join(';');
    const url = `https://router.project-osrm.org/trip/v1/driving/${coords}?roundtrip=false&source=first&destination=last&overview=false`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.code !== 'Ok') throw new Error('OSRM trip error');

    const mapped = [...data.waypoints]
      .sort((a, b) => a.waypoint_index - b.waypoint_index)
      .filter(w => w.waypoint_index > 0)
      .map(w => {
        const [wlng, wlat] = w.location;
        return pendientes.find(c => Math.abs(c.lat - wlat) < 0.0001 && Math.abs(c.lng - wlng) < 0.0001);
      })
      .filter(Boolean);

    if (mapped.length === pendientes.length) {
      ordenados = mapped;
    } else {
      throw new Error('Mismatch');
    }
  } catch(e) {
    try {
      const puntos = [origen, ...pendientes.map(c => ({ lat: c.lat, lng: c.lng }))];
      const coords2 = puntos.map(p => `${p.lng},${p.lat}`).join(';');
      const res2 = await fetch(`https://router.project-osrm.org/table/v1/driving/${coords2}?annotations=duration`);
      const data2 = await res2.json();
      if (data2.code !== 'Ok') throw new Error();
      const matrix = data2.durations;
      const n = pendientes.length;
      const visitado = new Array(n).fill(false);
      const ord2 = [];
      let actual = 0;
      for (let paso = 0; paso < n; paso++) {
        let mejorIdx = -1, mejorTiempo = Infinity;
        for (let i = 0; i < n; i++) {
          if (!visitado[i] && matrix[actual][i+1] < mejorTiempo) { mejorTiempo = matrix[actual][i+1]; mejorIdx = i; }
        }
        visitado[mejorIdx] = true; ord2.push(pendientes[mejorIdx]); actual = mejorIdx + 1;
      }
      ordenados = ord2;
    } catch(e2) {
      ordenados = haversineFallback(origen);
      alert('‚ö†Ô∏è Sin conexi√≥n a OSRM, se us√≥ distancia real en km.');
    }
  }

  clientes = [...ordenados, ...resto];
  tabActual = 'pendientes';
  switchTab('pendientes');
  guardar();
  if (btn) { btn.textContent = '‚ö° Cercan√≠a'; btn.disabled = false; }
}

function cargarArchivo(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => procesarJSON(ev.target.result);
  reader.readAsText(file);
}

function cargarPegado() {
  const txt = document.getElementById('jsonPaste').value.trim();
  if (!txt) return alert('Pega el contenido JSON primero');
  procesarJSON(txt);
}

function procesarJSON(txt) {
  try {
    const data = JSON.parse(txt);
    let lista = Array.isArray(data) ? data : [...(data.clientes || []), ...(data.sin_ubicacion || [])];
    lista.forEach(nuevo => {
      const existe = clientes.find(c => c.id === nuevo.id);
      if (existe) {
        Object.assign(existe, nuevo, { estado: existe.estado });
      } else {
        clientes.push({ ...nuevo, estado: nuevo.estado || 'pendiente' });
      }
    });
    guardar();
    closeModal('modalCargar');
    alert(`‚úÖ ${lista.length} clientes cargados`);
  } catch(e) { alert('Error: JSON no v√°lido'); }
}

let nextId = () => Math.max(0, ...clientes.map(c => c.id || 0)) + 1;

function editarCliente(id) {
  const c = clientes.find(x => x.id === id);
  if (!c) return;
  document.getElementById('editId').value = id;
  document.getElementById('modalClienteTitulo').textContent = '‚úèÔ∏è Editar Cliente';
  document.getElementById('cNombre').value = c.nombre || '';
  document.getElementById('cTel').value = c.telefono || '';
  document.getElementById('cCod').value = c.cod || '';
  document.getElementById('cLat').value = c.lat || '';
  document.getElementById('cLng').value = c.lng || '';
  openModal('modalCliente');
}

function guardarCliente() {
  const editId = document.getElementById('editId').value;
  const nombre = document.getElementById('cNombre').value.trim();
  const telefono = document.getElementById('cTel').value.trim();
  const cod = parseFloat(document.getElementById('cCod').value) || 0;
  const lat = parseFloat(document.getElementById('cLat').value) || null;
  const lng = parseFloat(document.getElementById('cLng').value) || null;
  if (!nombre) return alert('El nombre es requerido');
  if (editId) {
    const c = clientes.find(x => x.id == editId);
    if (c) { c.nombre = nombre; c.telefono = telefono; c.cod = cod; c.lat = lat; c.lng = lng; }
  } else {
    clientes.push({ id: nextId(), nombre, telefono, cod, lat, lng, estado: 'pendiente' });
  }
  guardar();
  closeModal('modalCliente');
}

function abrirUbi(id) {
  document.getElementById('ubiId').value = id;
  document.getElementById('ubiInput').value = '';
  openModal('modalUbi');
}

function guardarUbicacion() {
  const id = document.getElementById('ubiId').value;
  const txt = document.getElementById('ubiInput').value;
  const match = txt.match(/(-?\d+\.?\d*)[,\s]+(-?\d+\.?\d*)/);
  if (!match) return alert('No se encontraron coordenadas. Formato: 19.2917, -70.2558');
  const c = clientes.find(x => x.id == id);
  if (c) { c.lat = parseFloat(match[1]); c.lng = parseFloat(match[2]); guardar(); closeModal('modalUbi'); }
}

function openModal(id) {
  if (id === 'modalCliente') {
    document.getElementById('editId').value = '';
    document.getElementById('modalClienteTitulo').textContent = '‚ûï Nuevo Cliente';
    ['cNombre','cTel','cCod','cLat','cLng'].forEach(i => document.getElementById(i).value = '');
  }
  document.getElementById(id).classList.add('open');
}
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); }));

render();
</script>

</body>
</html>
