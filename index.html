<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Llega Ya | Sistema Real</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --red: #E60042; --blue: #007AFF; --green: #28a745; --bg: #F8F9FA; }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); font-family: 'Outfit', sans-serif; padding-bottom: 100px; }
        
        header { background: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top:0; z-index:100; }
        .logo { font-weight: 900; color: var(--red); font-size: 1.5rem; cursor: pointer; }
        .gps-status { color: var(--green); font-size: 0.7rem; font-weight: 700; margin-top: 5px; }

        /* BOT√ìN PRINCIPAL PARA EL TRABAJADOR */
        .btn-main-add { 
            background: var(--blue); color: white; margin: 15px; padding: 15px; 
            border-radius: 15px; text-align: center; font-weight: 800; border: none; 
            width: calc(100% - 30px); display: block; box-shadow: 0 4px 15px rgba(0,122,255,0.3);
        }

        /* FORMULARIO AGREGAR */
        #form-nuevo { display: none; background: white; margin: 15px; padding: 20px; border-radius: 20px; border: 2px solid var(--blue); }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #DDD; font-family: 'Outfit'; }

        /* TARJETAS */
        .card { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #EEE; }
        .card.done { opacity: 0.5; filter: grayscale(1); }
        .client-name { font-size: 1.2rem; font-weight: 800; display: block; margin-bottom: 5px; }
        .client-meta { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        .price { color: var(--green); font-weight: 800; background: #EFFFF4; padding: 2px 6px; border-radius: 5px; }

        /* BOTONES DE ACCI√ìN */
        .btn-nav { background: var(--blue); color: white; width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: 800; margin-bottom: 10px; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-sec { padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 0.8rem; }
        .btn-finish { background: var(--red); color: white; width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 800; margin-top: 10px; }

        /* PANEL JEFE */
        #admin-panel { display: none; background: #111; color: white; padding: 20px; margin: 15px; border-radius: 20px; }
        textarea { width: 100%; background: #000; color: #0f0; padding: 10px; border-radius: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="toggleAdmin()">LLEGA YA ELITE üõµ</div>
    <div class="gps-status">‚óè GPS ACTIVADO</div>
</header>

<button class="btn-main-add" onclick="toggleForm()">+ AGREGAR NUEVO CLIENTE</button>

<div id="form-nuevo">
    <h3 style="margin-bottom:10px; color:var(--blue);">Nuevo Pedido</h3>
    <input type="text" id="n-nombre" placeholder="Nombre del Cliente">
    <input type="tel" id="n-tel" placeholder="Tel√©fono">
    <input type="number" id="n-monto" placeholder="Monto RD$">
    <button onclick="guardarManual()" style="background:var(--blue); color:white; width:100%; padding:15px; border-radius:12px; border:none; font-weight:800;">GUARDAR Y FIJAR GPS</button>
    <button onclick="toggleForm()" style="background:none; border:none; width:100%; margin-top:10px; color:#999;">Cancelar</button>
</div>

<div id="admin-panel">
    <h3>Panel Jefe</h3>
    <input type="file" id="f-json" accept=".json" style="margin: 10px 0; color: white;">
    <textarea id="t-json" rows="4" placeholder="O pega el c√≥digo aqu√≠..."></textarea>
    <button onclick="generarLink()" style="background:var(--green); color:white; width:100%; padding:12px; border-radius:10px; border:none; font-weight:800;">CREAR LINK WHATSAPP</button>
    <div id="res-link" style="display:none; background:black; color:#0f0; padding:10px; border-radius:10px; font-size:0.6rem; word-break:break-all; margin-top:10px;"></div>
    <button onclick="toggleAdmin()" style="background:none; border:1px solid #444; color:white; width:100%; margin-top:10px; padding:5px; border-radius:8px;">Cerrar</button>
</div>

<div id="app"></div>

<script>
    let db = JSON.parse(localStorage.getItem('ly_v10')) || { clientes: [] };
    let miPos = { lat: 0, lng: 0 };

    function start() {
        navigator.geolocation.watchPosition(p => {
            miPos = { lat: p.coords.latitude, lng: p.coords.longitude };
            render();
        }, null, {enableHighAccuracy:true});

        // Lector de archivos
        document.getElementById('f-json').addEventListener('change', function(e) {
            const r = new FileReader();
            r.onload = function(e) { document.getElementById('t-json').value = e.target.result; };
            r.readAsText(e.target.files[0]);
        });

        // Cargar por URL
        const params = new URLSearchParams(window.location.search);
        const ruta = params.get('ruta');
        if(ruta) {
            try {
                const data = JSON.parse(decodeURIComponent(atob(ruta)));
                db.clientes = data.clientes || [];
                save();
                window.history.replaceState({}, '', window.location.pathname);
            } catch(e) {}
        }
        render();
    }

    function render() {
        const cont = document.getElementById('app');
        if(db.clientes.length === 0) {
            cont.innerHTML = '<p style="text-align:center; padding:50px; opacity:0.5;">Esperando pedidos...</p>';
            return;
        }

        let html = '';
        db.clientes.sort((a,b) => (a.estado === 'entregado' ? 1 : -1)).forEach(c => {
            const done = c.estado === 'entregado';
            html += `
            <div class="card ${done ? 'done' : ''}">
                <span class="client-name">${c.nombre}</span>
                <div class="client-meta">${c.telefono} | <span class="price">RD$ ${c.cod}</span></div>
                <button class="btn-nav" onclick="ir('${c.lat}','${c.lng}')">üöÄ IR AL MAPA</button>
                <div class="btn-row">
                    <button class="btn-sec" style="background:#FFF0F4; color:var(--red);" onclick="reubicar(${c.id})">üìç MOVER</button>
                    <button class="btn-sec" style="background:#EFFFF4; color:var(--green);" onclick="window.open('https://wa.me/${c.telefono}')">WHATSAPP</button>
                </div>
                <button class="btn-finish" onclick="completar(${c.id})">${done ? '‚úì ENTREGADO' : 'MARCAR ENTREGADO'}</button>
            </div>`;
        });
        cont.innerHTML = html;
    }

    function toggleForm() { 
        const f = document.getElementById('form-nuevo');
        f.style.display = f.style.display === 'block' ? 'none' : 'block';
    }

    function guardarManual() {
        const n = document.getElementById('n-nombre').value;
        const t = document.getElementById('n-tel').value;
        const m = document.getElementById('n-monto').value;
        if(!n || !t) return alert("Llena nombre y tel√©fono");
        if(!miPos.lat) return alert("GPS buscando...");

        db.clientes.unshift({ id: Date.now(), nombre: n, telefono: t, cod: m, lat: miPos.lat, lng: miPos.lng, estado: 'pendiente' });
        save();
        toggleForm();
        document.getElementById('n-nombre').value = '';
        document.getElementById('n-tel').value = '';
        document.getElementById('n-monto').value = '';
    }

    function ir(la, ln) { window.open(`https://www.google.com/maps/dir/?api=1&destination=${la},${ln}&travelmode=motorcycle`); }
    function reubicar(id) { if(confirm("¬øFijar cliente en tu ubicaci√≥n actual?")) { db.clientes.find(x=>x.id==id).lat = miPos.lat; db.clientes.find(x=>x.id==id).lng = miPos.lng; save(); } }
    function completar(id) { db.clientes.find(x=>x.id==id).estado = 'entregado'; save(); }
    function save() { localStorage.setItem('ly_v10', JSON.stringify(db)); render(); }
    function toggleAdmin() { if(prompt("Clave:") === "1234") { const p = document.getElementById('admin-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; } }
    
    function generarLink() {
        const b64 = btoa(encodeURIComponent(document.getElementById('t-json').value));
        const l = `${window.location.href.split('?')[0]}?ruta=${b64}`;
        const box = document.getElementById('res-link');
        box.style.display = 'block';
        box.innerHTML = `Link: ${l} <br><button onclick="navigator.clipboard.writeText('${l}');alert('Copiado')">Copiar</button>`;
    }

    start();
</script>
</body>
</html>
