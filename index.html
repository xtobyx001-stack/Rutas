<!DOCTYPE html>

<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLEGA YA ELITE | FINAL</title>
    <style>
        :root { --bg: #020617; --card: #1e293b; --blue: #3b82f6; --green: #10b981; --orange: #f59e0b; --red: #ef4444; --purple: #8b5cf6; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); color: white; padding-bottom: 100px; }
        header { background: var(--card); padding: 15px; text-align: center; border-bottom: 1px solid #334155; position: sticky; top: 0; z-index: 100; }
        .sort-bar { padding: 10px; background: #0f172a; border-bottom: 1px solid #334155; }
        .btn-sort { background: var(--purple); width: 100%; padding: 14px; border-radius: 10px; border: none; color: white; font-weight: bold; cursor: pointer; }
        #list { padding: 10px; }
        .card { background: var(--card); margin-bottom: 15px; padding: 15px; border-radius: 15px; border-left: 5px solid var(--blue); }
        .card.done { border-left-color: var(--green); opacity: 0.5; }
        h3 { font-size: 1.2rem; margin-bottom: 10px; text-transform: uppercase; }
        .btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: bold; color: white; cursor: pointer; margin-bottom: 8px; display: block; text-align: center; text-decoration: none; font-size: 1rem; }
        .btn-paste { background: var(--orange); color: black; } 
        .btn-maps { background: var(--blue); }
        .btn-wa { background: #25d366; }
        .row { display: flex; gap: 8px; }
        .btn-s { flex: 1; padding: 12px; border-radius: 8px; border: none; color: white; font-weight: bold; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; padding: 25px; z-index: 1000; justify-content: center; overflow-y: auto; }
        input, textarea { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 10px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 1rem; }
        .float { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 99; }
        .circle { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .origin-info { background: #1e293b; border: 1px solid var(--purple); border-radius: 10px; padding: 10px 15px; margin: 10px; font-size: 0.85rem; color: #a78bfa; text-align: center; }
    </style>
</head>
<body>

<header><h1>LLEGA YA ELITE üõµ</h1></header>

<div class="origin-info">üìç Salida fija: Sanchez casa 9A, San Francisco de Macor√≠s</div>

<div class="sort-bar">
    <button class="btn-sort" onclick="sortNearest()">‚ö° ORDENAR POR CERCAN√çA</button>
</div>

<div id="list"></div>

<div class="float">
    <button class="circle" style="background: var(--green)" onclick="showM('addM')">+</button>
    <button class="circle" style="background: var(--blue)" onclick="showM('cfgM')">‚öôÔ∏è</button>
</div>

<div id="filePasteM" class="modal">
    <h2 style="color:var(--blue);">Pegar Contenido del Archivo</h2><br>
    <textarea id="fileInputContent" rows="10" placeholder="Pega aqu√≠ el texto del JSON o el c√≥digo de la ruta..."></textarea>
    <button class="btn" style="background:var(--green)" onclick="processFileContent()">CARGAR RUTA</button>
    <button class="btn" style="background:var(--red)" onclick="hideM()">CANCELAR</button>
</div>

<div id="pasteM" class="modal">
    <h2 style="color:var(--orange);">Pegar Ubicaci√≥n</h2><br>
    <textarea id="coordsInput" rows="5" placeholder="Pega el link o coordenadas..."></textarea>
    <input type="hidden" id="targetId">
    <button class="btn" style="background:var(--green)" onclick="saveManualLocation()">GUARDAR PIN</button>
    <button class="btn" style="background:var(--red)" onclick="hideM()">CANCELAR</button>
</div>

<div id="addM" class="modal">
    <h2>Nuevo Cliente</h2><br>
    <input type="text" id="n" placeholder="Nombre">
    <input type="tel" id="t" placeholder="WhatsApp">
    <button class="btn" style="background:var(--green)" onclick="add()">A√ëADIR</button>
    <button class="btn" style="background:var(--red)" onclick="hideM()">CERRAR</button>
</div>

<div id="cfgM" class="modal">
    <h2>Opciones</h2><br>
    <button class="btn" style="background:var(--blue)" onclick="hideM(); showM('filePasteM')">üìã PEGAR ARCHIVO / C√ìDIGO</button>
    <button class="btn" style="background:var(--red)" onclick="if(confirm('¬øBorrar todo?')){localStorage.clear(); location.reload();}">üóëÔ∏è LIMPIAR TODO</button>
    <button class="btn" style="background:var(--card)" onclick="hideM()">CERRAR</button>
</div>

<script>
    // Punto de salida fijo: Sanchez casa 9A, San Francisco de Macor√≠s
    const ORIGIN_LAT = 19.3009;
    const ORIGIN_LNG = -70.2531;

    let db = JSON.parse(localStorage.getItem('ly_master_final')) || [];

    function render() {
        const div = document.getElementById('list');
        div.innerHTML = '';
        if (db.length === 0) div.innerHTML = '<p style="text-align:center;padding:40px;opacity:0.5;">Vac√≠o. Usa ‚öôÔ∏è para pegar tu archivo.</p>';
        
        db.forEach((c, i) => {
            const lat = c.lt || c.lat || 0;
            const lng = c.lg || c.lng || 0;
            const mapsUrl = (lat != 0) ? `https://www.google.com/maps?q=${lat},${lng}` : "#";

            const card = document.createElement('div');
            card.className = `card ${c.s === 'ok' ? 'done' : ''}`;
            card.innerHTML = `
                <h3>${c.n || c.nombre || "Cliente"}</h3>
                <button class="btn btn-paste" onclick="openPastePanel(${i})">üìã PEGAR UBICACI√ìN</button>
                <a class="btn btn-maps" href="${mapsUrl}" target="_blank">üöÄ IR AL MAPA</a>
                <a class="btn btn-wa" href="https://wa.me/${c.t || c.telefono || ''}" target="_blank">üí¨ WHATSAPP</a>
                <div class="row">
                    <button class="btn-s" style="background:var(--green)" onclick="status(${i},'ok')">LISTO</button>
                    <button class="btn-s" style="background:var(--red)" onclick="status(${i},'no')">FALL√ì</button>
                </div>
            `;
            div.appendChild(card);
        });
    }

    function processFileContent() {
        const raw = document.getElementById('fileInputContent').value.trim();
        try {
            let data;
            if (raw.startsWith('[') || raw.startsWith('{')) {
                data = JSON.parse(raw);
            } else {
                data = JSON.parse(decodeURIComponent(escape(atob(raw))));
            }
            db = Array.isArray(data) ? data : (data.clientes || []);
            save(); hideM();
        } catch(e) { alert("Error: El contenido no es v√°lido."); }
    }

    function sortNearest() {
        // Siempre parte desde el origen fijo: Sanchez casa 9A, San Francisco de Macor√≠s
        let lat = ORIGIN_LAT;
        let lng = ORIGIN_LNG;

        let p = [...db.filter(x => x.s !== 'ok')];
        let d = [...db.filter(x => x.s === 'ok')];
        let s = [];

        while(p.length > 0) {
            let idx = 0, min = Infinity;
            p.forEach((c, i) => {
                let dist = Math.sqrt(Math.pow((c.lt||0)-lat,2) + Math.pow((c.lg||0)-lng,2));
                if(dist < min) { min = dist; idx = i; }
            });
            let n = p.splice(idx, 1)[0];
            s.push(n);
            lat = n.lt || lat;
            lng = n.lg || lng;
        }

        db = [...s, ...d];
        save();
        alert('‚úÖ Ruta ordenada desde Sanchez casa 9A');
    }

    function openPastePanel(i) { document.getElementById('targetId').value = i; showM('pasteM'); }
    function saveManualLocation() {
        const i = document.getElementById('targetId').value;
        const txt = document.getElementById('coordsInput').value;
        const reg = /(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)/;
        const m = txt.match(reg);
        if(m) { db[i].lt = parseFloat(m[1]); db[i].lg = parseFloat(m[2]); save(); hideM(); }
        else { alert("No se encontraron coordenadas v√°lidas. Aseg√∫rate de pegar coordenadas como: 19.3045, -70.2498"); }
    }

    function status(i, s) { db[i].s = s; save(); }
    function save() { localStorage.setItem('ly_master_final', JSON.stringify(db)); render(); }
    function add() {
        db.push({ n: document.getElementById('n').value, t: document.getElementById('t').value, lt: 0, lg: 0, s: 'p' });
        save(); hideM();
    }
    function showM(id) { document.getElementById(id).style.display = 'flex'; }
    function hideM() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    render();
</script>

</body>
</html>