<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Llega Ya | Panel de Ruta</title>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue: #3b82f6; --green: #10b981; --red: #ef4444; --orange: #f59e0b;
            --bg: #020617; --card: #0f172a; --border: rgba(255,255,255,0.1);
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); color: white; font-family: 'Figtree', sans-serif; padding-bottom: 120px; }
        
        header { padding: 15px; background: var(--card); border-bottom: 1px solid var(--border); text-align: center; position: sticky; top: 0; z-index: 100; }
        .logo { font-family: 'JetBrains Mono'; font-weight: bold; color: var(--blue); font-size: 1.4rem; }
        #gps-bar { font-size: 0.7rem; color: var(--green); margin-top: 4px; }

        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .kpi { background: var(--card); padding: 12px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .kpi b { display: block; color: var(--blue); font-size: 1.2rem; font-family: 'JetBrains Mono'; }
        .kpi span { font-size: 0.6rem; text-transform: uppercase; opacity: 0.6; }

        .card { background: var(--card); margin: 0 15px 12px; padding: 15px; border-radius: 16px; border: 1px solid var(--border); position: relative; }
        .card.done { opacity: 0.5; transform: scale(0.98); }
        .card-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; display: block; }
        .card-info { font-size: 0.85rem; opacity: 0.8; margin-bottom: 12px; font-family: 'JetBrains Mono'; }
        .dist { font-size: 0.7rem; color: var(--orange); font-weight: bold; margin-bottom: 5px; display: block; }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .btn-status { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
        
        button { padding: 12px; border-radius: 10px; border: none; font-weight: 700; color: white; font-family: inherit; cursor: pointer; }
        .b-blue { background: var(--blue); } .b-green { background: var(--green); } 
        .b-red { background: var(--red); } .b-orange { background: var(--orange); color: #000; }
        .b-glass { background: rgba(255,255,255,0.05); border: 1px solid var(--border); }

        .nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(15,23,42,0.9); backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 50px; border: 1px solid var(--border); display: flex; gap: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 500; }
        .nav-i { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: var(--blue); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-c { background: var(--card); padding: 25px; border-radius: 20px; width: 100%; max-width: 350px; border: 1px solid var(--border); }
        input, textarea { width: 100%; background: #1e293b; border: 1px solid var(--border); padding: 12px; border-radius: 10px; color: white; margin-bottom: 10px; font-size: 1rem; }
    </style>
</head>
<body>

<header>
    <div class="logo">LLEGA YA</div>
    <div id="gps-bar">Esperando GPS...</div>
</header>

<div class="stats">
    <div class="kpi"><span>Entregas</span><b id="s-cnt">0/0</b></div>
    <div class="kpi"><span>Cobrado</span><b id="s-cash">RD$ 0</b></div>
</div>

<div id="list"></div>

<div class="nav">
    <div class="nav-i" onclick="openM('m-add')">‚ûï</div>
    <div class="nav-i" onclick="openM('m-js')" style="background:var(--orange)">üìù</div>
    <div class="nav-i" onclick="document.getElementById('f-in').click()" style="background:var(--green)">üìÇ</div>
    <div class="nav-i" onclick="openM('m-cp')" style="background:#64748b">‚öôÔ∏è</div>
</div>

<input type="file" id="f-in" style="display:none" accept=".json">

<div id="m-add" class="modal"><div class="modal-c"><h3>Nuevo Cliente</h3><input id="n-nom" placeholder="Nombre"><input id="n-tel" placeholder="Tel√©fono" type="tel"><input id="n-cod" placeholder="Monto RD$" type="number"><button class="b-green" style="width:100%" onclick="addM()">Guardar</button><button class="b-glass" style="width:100%; margin-top:8px" onclick="closeM()">Cerrar</button></div></div>
<div id="m-js" class="modal"><div class="modal-c"><h3>Pegar JSON</h3><textarea id="t-js" rows="6" placeholder="Pega aqu√≠..."></textarea><button class="b-blue" style="width:100%" onclick="impJS()">Importar</button><button class="b-glass" style="width:100%; margin-top:8px" onclick="closeM()">Cerrar</button></div></div>
<div id="m-cp" class="modal"><div class="modal-c"><h3>Opciones</h3><button class="b-red" style="width:100%" onclick="reset()">üóëÔ∏è Borrar Todo</button><button class="b-glass" style="width:100%; margin-top:8px" onclick="closeM()">Cerrar</button></div></div>

<script>
    let db = JSON.parse(localStorage.getItem('ly_vPro')) || { clientes: [], sin_ubicacion: [] };
    let myLoc = { lat: 0, lng: 0 };

    function init() {
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                myLoc = { lat: p.coords.latitude, lng: p.coords.longitude };
                document.getElementById('gps-bar').innerText = `üìç GPS: ${myLoc.lat.toFixed(5)}, ${myLoc.lng.toFixed(5)}`;
                render();
            }, null, {enableHighAccuracy:true});
        }
        render();
    }

    function getD(l1, n1, l2, n2) {
        if(!l1 || !l2) return 999;
        const R = 6371;
        const dL = (l2-l1)*Math.PI/180; const dN = (n2-n1)*Math.PI/180;
        const a = Math.sin(dL/2)**2 + Math.cos(l1*Math.PI/180)*Math.cos(l2*Math.PI/180)*Math.sin(dN/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function render() {
        const box = document.getElementById('list');
        const todos = [...db.clientes, ...db.sin_ubicacion];
        if(!todos.length) { box.innerHTML = '<p style="text-align:center;padding:40px;opacity:0.4">Lista vac√≠a</p>'; return; }

        const orden = db.clientes.sort((a,b) => {
            if (a.estado === 'entregado' && b.estado !== 'entregado') return 1;
            if (a.estado !== 'entregado' && b.estado === 'entregado') return -1;
            return getD(myLoc.lat, myLoc.lng, a.lat, a.lng) - getD(myLoc.lat, myLoc.lng, b.lat, b.lng);
        });

        let h = '<div style="font-size:0.7rem;opacity:0.4;padding:10px 20px">ORDEN POR CERCAN√çA</div>';
        orden.forEach(c => h += card(c, `A ${getD(myLoc.lat, myLoc.lng, c.lat, c.lng).toFixed(2)} km`, true));
        
        if(db.sin_ubicacion.length) {
            h += '<div style="font-size:0.7rem;opacity:0.4;padding:20px 20px 10px">SIN UBICACI√ìN</div>';
            db.sin_ubicacion.forEach(c => h += card(c, "Ubicaci√≥n pendiente", false));
        }
        box.innerHTML = h;
        const ok = todos.filter(x => x.estado === 'entregado');
        document.getElementById('s-cnt').innerText = `${ok.length}/${todos.length}`;
        document.getElementById('s-cash').innerText = `RD$ ${ok.reduce((a,b)=>a+(Number(b.cod)||0),0).toLocaleString()}`;
    }

    function card(c, dist, has) {
        const s = c.estado || 'pendiente';
        return `
        <div class="card ${s!=='pendiente'?'done':''}">
            <span class="dist">${dist}</span>
            <span class="card-name">${c.nombre}</span>
            <div class="card-info">üìû ${c.telefono} | RD$ ${Number(c.cod).toLocaleString()}</div>
            <div class="btn-row">
                <button class="b-green" style="background:#25d366" onclick="window.open('https://wa.me/${c.telefono}')">WA</button>
                <button class="b-orange" onclick="updUbi(${c.id})">üìç Mi Posici√≥n</button>
            </div>
            ${has ? `<button class="b-blue" style="width:100%;margin-bottom:8px" onclick="window.open('https://www.google.com/maps?q=${c.lat},${c.lng}')">Ver Mapa</button>` : ''}
            <div class="btn-status">
                <button class="b-green" onclick="st(${c.id},'entregado')">OK</button>
                <button class="b-red" onclick="st(${c.id},'rechazado')">NO</button>
                <button class="b-glass" onclick="st(${c.id},'pendiente')">‚Ü©</button>
            </div>
        </div>`;
    }

    function st(id, s) { [...db.clientes, ...db.sin_ubicacion].forEach(c => {if(c.id==id) c.estado=s;}); save(); }

    function updUbi(id) {
        if(!myLoc.lat) return alert("GPS no listo");
        let c = db.clientes.find(x => x.id == id);
        if(!c) {
            let i = db.sin_ubicacion.findIndex(x => x.id == id);
            c = db.sin_ubicacion.splice(i, 1)[0];
            db.clientes.push(c);
        }
        c.lat = myLoc.lat; c.lng = myLoc.lng;
        save(); alert("Ubicaci√≥n guardada en tu punto actual");
    }

    function addM() {
        const n = document.getElementById('n-nom').value;
        const t = document.getElementById('n-tel').value;
        const k = document.getElementById('n-cod').value;
        if(!n || !t) return;
        db.sin_ubicacion.push({id:Date.now(), nombre:n, telefono:t, cod:k||0, estado:'pendiente'});
        save(); closeM();
    }

    function impJS() { try { const j = JSON.parse(document.getElementById('t-js').value); db = {clientes:j.clientes||[], sin_ubicacion:j.sin_ubicacion||[]}; save(); closeM(); } catch(e){alert("Error JSON");} }

    document.getElementById('f-in').onchange = (e) => {
        const r = new FileReader();
        r.onload = (v) => { const j = JSON.parse(v.target.result); db = {clientes:j.clientes||[], sin_ubicacion:j.sin_ubicacion||[]}; save(); };
        r.readAsText(e.target.files[0]);
    };

    function save() { localStorage.setItem('ly_vPro', JSON.stringify(db)); render(); }
    function openM(id) { document.getElementById(id).style.display = 'flex'; }
    function closeM() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
    function reset() { if(confirm('¬øBorrar ruta?')) { localStorage.removeItem('ly_vPro'); location.reload(); } }

    init();
</script>
</body>
</html>
