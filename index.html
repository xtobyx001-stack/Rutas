<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Llega Ya | Manual Fix</title>
    <style>
        :root { --bg: #020617; --card: #1e293b; --blue: #3b82f6; --green: #10b981; --orange: #f59e0b; --red: #ef4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); color: white; padding-bottom: 100px; }
        
        header { background: var(--card); padding: 15px; text-align: center; border-bottom: 1px solid #334155; }
        .stats { display: flex; justify-content: space-around; padding: 10px; background: #0f172a; font-weight: bold; font-size: 0.9rem; }

        .card { background: var(--card); margin: 15px; padding: 15px; border-radius: 12px; border-left: 5px solid var(--blue); }
        .card.done { border-left-color: var(--green); opacity: 0.5; }
        
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; font-weight: bold; color: white; cursor: pointer; margin-bottom: 8px; display: block; text-align: center; text-decoration: none; }
        .btn-maps { background: var(--blue); }
        .btn-paste { background: var(--orange); color: black; } /* ESTE ABRE EL CUADRO PARA PEGAR */
        
        .row { display: flex; gap: 5px; }
        .btn-s { flex: 1; padding: 12px; border-radius: 8px; border: none; color: white; font-weight: bold; }

        /* VENTANA PARA PEGAR (MODAL) */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; padding: 20px; z-index: 1000; justify-content: center; }
        textarea { width: 100%; padding: 15px; border-radius: 10px; background: #0f172a; color: white; border: 1px solid var(--blue); font-size: 1rem; margin-bottom: 10px; }
        
        .float { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
        .circle { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 1.5rem; }
    </style>
</head>
<body>

<header><h1>LLEGA YA ELITE</h1></header>
<div class="stats">
    <div>PEDIDOS: <span id="count">0/0</span></div>
    <div>RD$: <span id="cash">0</span></div>
</div>

<div id="list"></div>

<div class="float">
    <button class="circle" style="background: var(--green)" onclick="openM('addM')">+</button>
    <button class="circle" style="background: var(--blue)" onclick="openM('cfgM')">‚öôÔ∏è</button>
</div>

<div id="pasteModal" class="modal">
    <h2 style="margin-bottom:10px">Pegar Nueva Ubicaci√≥n</h2>
    <p style="font-size:0.8rem; margin-bottom:10px; opacity:0.7">Pega el link de WhatsApp o las coordenadas aqu√≠:</p>
    <textarea id="inputUbi" rows="5" placeholder="Pega aqu√≠ el link de Google Maps..."></textarea>
    <input type="hidden" id="activeIdx">
    <button class="btn" style="background:var(--green)" onclick="confirmarUbi()">GUARDAR UBICACI√ìN NUEVA</button>
    <button class="btn" style="background:var(--red)" onclick="closeM()">CANCELAR</button>
</div>

<div id="addM" class="modal">
    <h2>Nuevo Cliente</h2><br>
    <input type="text" id="newN" placeholder="Nombre" style="width:100%; padding:10px; margin-bottom:10px;">
    <input type="number" id="newM" placeholder="Monto RD$" style="width:100%; padding:10px; margin-bottom:10px;">
    <button class="btn" style="background:var(--green)" onclick="agregar()">A√ëADIR</button>
    <button class="btn" style="background:var(--red)" onclick="closeM()">CERRAR</button>
</div>

<div id="cfgM" class="modal">
    <button class="btn btn-maps" onclick="document.getElementById('f').click()">üìÇ CARGAR RUTA JSON</button>
    <button class="btn" style="background:var(--red)" onclick="localStorage.clear(); location.reload()">üóëÔ∏è BORRAR TODO</button>
    <button class="btn" style="background:var(--card)" onclick="closeM()">CERRAR</button>
</div>

<input type="file" id="f" style="display:none">

<script>
    let clientes = JSON.parse(localStorage.getItem('ly_v12')) || [];

    function render() {
        const box = document.getElementById('list');
        box.innerHTML = '';
        clientes.forEach((c, i) => {
            const div = document.createElement('div');
            div.className = `card ${c.s === 'ok' ? 'done' : ''}`;
            div.innerHTML = `
                <h3>${c.n}</h3>
                <p>RD$ ${c.m || 0}</p>
                
                <button class="btn btn-paste" onclick="abrirPegar(${i})">üìã PEGAR NUEVA UBICACI√ìN</button>
                
                <a class="btn btn-maps" href="https://www.google.com/maps/dir/?api=1&destination=${c.lt},${c.lg}&travelmode=motorcycle" target="_blank">üöÄ IR AL MAPA</a>
                
                <div class="row">
                    <button class="btn-s" style="background:var(--green)" onclick="cambiarEstado(${i},'ok')">LISTO</button>
                    <button class="btn-s" style="background:var(--red)" onclick="cambiarEstado(${i},'no')">NO</button>
                </div>
            `;
            box.appendChild(div);
        });
        actualizarStats();
    }

    // ABRE EL MODAL Y TE DA EL CAMPO PARA PEGAR
    function abrirPegar(i) {
        document.getElementById('activeIdx').value = i;
        document.getElementById('inputUbi').value = '';
        document.getElementById('pasteModal').style.display = 'flex';
    }

    function confirmarUbi() {
        const i = document.getElementById('activeIdx').value;
        const texto = document.getElementById('inputUbi').value;
        
        // Busca coordenadas en el texto pegado
        const reg = /(-?\d+\.\d+)\s*,\s*(-?\d+\.\d+)/;
        const match = texto.match(reg);
        
        if(match) {
            clientes[i].lt = match[1];
            clientes[i].lg = match[2];
            guardar();
            closeM();
            alert("Ubicaci√≥n actualizada correctamente.");
        } else {
            alert("No se encontraron coordenadas. Pega el link completo o n√∫meros como: 18.4, -69.9");
        }
    }

    function cambiarEstado(i, s) { clientes[i].s = s; guardar(); }
    function guardar() { localStorage.setItem('ly_v12', JSON.stringify(clientes)); render(); }
    
    function agregar() {
        const n = document.getElementById('newN').value;
        if(!n) return;
        clientes.push({ n: n, m: document.getElementById('newM').value, lt: 0, lg: 0, s: 'p' });
        guardar(); closeM();
    }

    function actualizarStats() {
        const ok = clientes.filter(x => x.s === 'ok');
        document.getElementById('count').innerText = `${ok.length}/${clientes.length}`;
        document.getElementById('cash').innerText = ok.reduce((a,b) => a + Number(b.m || 0), 0);
    }

    function openM(id) { document.getElementById(id).style.display = 'flex'; }
    function closeM() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

    document.getElementById('f').addEventListener('change', e => {
        const r = new FileReader();
        r.onload = ev => { clientes = JSON.parse(ev.target.result).clientes || JSON.parse(ev.target.result); guardar(); closeM(); };
        r.readAsText(e.target.files[0]);
    });

    render();
</script>
</body>
</html>
