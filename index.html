<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Llega Ya | Original Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --red: #E60042; --blue: #007AFF; --green: #28a745; --bg: #F2F2F7; }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); font-family: 'Outfit', sans-serif; padding-bottom: 100px; }
        
        header { background: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top:0; z-index:100; }
        .logo { font-weight: 900; color: var(--red); font-size: 1.5rem; cursor: pointer; }

        /* PANEL DE CONTROL (PARA TI) */
        .panel-jefe { background: #111; color: white; margin: 15px; padding: 20px; border-radius: 20px; display: block; }
        .btn-archivo { background: #333; border: 2px dashed #555; padding: 10px; width: 100%; border-radius: 10px; color: white; margin-bottom: 10px; }
        textarea { width: 100%; background: #000; color: #0f0; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-family: monospace; border: 1px solid #333; }
        .btn-link { background: var(--green); color: white; width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 800; }

        /* AGREGAR CLIENTE (PARA EL MOTORISTA) */
        .btn-worker { background: var(--blue); color: white; margin: 15px; width: calc(100% - 30px); padding: 15px; border-radius: 15px; border: none; font-weight: 800; font-size: 1rem; }
        #form-add { display: none; background: white; margin: 15px; padding: 20px; border-radius: 20px; border: 2px solid var(--blue); }
        .input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid #DDD; font-family: 'Outfit'; }

        /* LISTA DE CLIENTES */
        .card { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #EEE; }
        .card.done { opacity: 0.5; filter: grayscale(1); }
        .c-title { font-size: 1.2rem; font-weight: 800; }
        .c-meta { font-size: 0.9rem; color: #666; margin-bottom: 15px; }
        .price { color: var(--green); font-weight: 800; }

        .btn-nav { background: var(--blue); color: white; width: 100%; padding: 18px; border-radius: 15px; border: none; font-weight: 800; margin-bottom: 10px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-s { padding: 14px; border-radius: 12px; border: none; font-weight: 700; font-size: 0.8rem; }
        .btn-ok { background: var(--red); color: white; width: 100%; padding: 16px; border-radius: 14px; border: none; font-weight: 800; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <div class="logo">LLEGA YA ELITE üõµ</div>
</header>

<div class="panel-jefe">
    <p style="font-size: 0.8rem; margin-bottom: 5px;">METER ARCHIVO JSON:</p>
    <input type="file" id="file-json" class="btn-archivo">
    <textarea id="text-json" rows="3" placeholder="O pega el c√≥digo aqu√≠..."></textarea>
    <button class="btn-link" onclick="generarLink()">COPIAR LINK PARA WHATSAPP</button>
    <div id="link-box" style="display:none; color:#0f0; font-size:0.6rem; word-break:break-all; margin-top:10px; border:1px solid #333; padding:10px;"></div>
</div>

<button class="btn-worker" onclick="showForm()">+ AGREGAR CLIENTE NUEVO</button>

<div id="form-add">
    <input type="text" id="add-name" class="input" placeholder="Nombre">
    <input type="tel" id="add-tel" class="input" placeholder="Tel√©fono">
    <input type="number" id="add-cod" class="input" placeholder="Monto RD$">
    <button onclick="saveManual()" style="background:var(--blue); color:white; width:100%; padding:15px; border-radius:12px; border:none; font-weight:800;">GUARDAR CON MI GPS</button>
</div>

<div id="lista"></div>

<script>
    let data = JSON.parse(localStorage.getItem('ly_simple_v1')) || { clientes: [] };
    let gps = { lat: 0, lng: 0 };

    function start() {
        navigator.geolocation.watchPosition(p => { gps = { lat: p.coords.latitude, lng: p.coords.longitude }; render(); }, null, {enableHighAccuracy:true});

        // Lector de archivos
        document.getElementById('file-json').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = (e) => { document.getElementById('text-json').value = e.target.result; };
            reader.readAsText(e.target.files[0]);
        });

        // Leer del link
        const p = new URLSearchParams(window.location.search);
        if(p.get('ruta')) {
            try {
                data.clientes = JSON.parse(decodeURIComponent(atob(p.get('ruta')))).clientes;
                save();
                window.history.replaceState({}, '', window.location.pathname);
            } catch(e) {}
        }
        render();
    }

    function render() {
        const box = document.getElementById('lista');
        if(data.clientes.length === 0) { box.innerHTML = '<p style="text-align:center; padding:40px; opacity:0.3;">No hay clientes.</p>'; return; }
        
        let h = '';
        data.clientes.sort((a,b) => (a.estado === 'entregado' ? 1 : -1)).forEach(c => {
            const done = c.estado === 'entregado';
            h += `
            <div class="card ${done ? 'done' : ''}">
                <span class="c-title">${c.nombre}</span>
                <div class="c-meta">${c.telefono} | <span class="price">RD$ ${c.cod}</span></div>
                <button class="btn-nav" onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}&travelmode=motorcycle')">üöÄ IR AL MAPA</button>
                <div class="btn-grid">
                    <button class="btn-s" style="background:#FFF0F4; color:var(--red);" onclick="updateLoc(${c.id})">üìç ACTUALIZAR GPS</button>
                    <button class="btn-s" style="background:#EFFFF4; color:var(--green);" onclick="window.open('https://wa.me/${c.telefono}')">WHATSAPP</button>
                </div>
                <button class="btn-ok" onclick="mark(${c.id})">${done ? '‚úì ENTREGADO' : 'MARCAR ENTREGADO'}</button>
            </div>`;
        });
        box.innerHTML = h;
    }

    function showForm() { const f = document.getElementById('form-add'); f.style.display = f.style.display === 'block' ? 'none' : 'block'; }

    function saveManual() {
        const n = document.getElementById('add-name').value;
        const t = document.getElementById('add-tel').value;
        const c = document.getElementById('add-cod').value;
        if(!n || !t) return alert("Nombre y Tel obligatorios");
        data.clientes.unshift({ id: Date.now(), nombre: n, telefono: t, cod: c, lat: gps.lat, lng: gps.lng, estado: 'pendiente' });
        save();
        showForm();
        document.getElementById('add-name').value=''; document.getElementById('add-tel').value=''; document.getElementById('add-cod').value='';
    }

    // 3. ACTUALIZAR UBICACI√ìN
    function updateLoc(id) {
        if(confirm("¬øCambiar ubicaci√≥n del cliente por tu posici√≥n actual?")) {
            const cli = data.clientes.find(x => x.id == id);
            cli.lat = gps.lat; cli.lng = gps.lng;
            save();
        }
    }

    function mark(id) { data.clientes.find(x => x.id == id).estado = 'entregado'; save(); }
    function save() { localStorage.setItem('ly_simple_v1', JSON.stringify(data)); render(); }

    // 4. GENERAR Y COPIAR LINK
    function generarLink() {
        const txt = document.getElementById('text-json').value;
        if(!txt) return alert("Sube un archivo o pega el c√≥digo primero");
        const b64 = btoa(encodeURIComponent(txt));
        const link = `${window.location.href.split('?')[0]}?ruta=${b64}`;
        navigator.clipboard.writeText(link);
        const res = document.getElementById('link-box');
        res.style.display = 'block';
        res.innerHTML = `LINK COPIADO AL PORTAPAPELES:<br>${link}`;
        alert("¬°Link copiado! P√©galo en WhatsApp.");
    }

    start();
</script>
</body>
</html>
