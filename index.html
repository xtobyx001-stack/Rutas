<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Llega Ya | Sistema de Flota</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --red: #E60042; --blue: #007AFF; --green: #28a745; --bg: #F8F9FA; --dark: #1A1A1A; }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body { background: var(--bg); color: var(--dark); font-family: 'Outfit', sans-serif; padding-bottom: 120px; }
        
        /* Header con acceso oculto al Jefe */
        header { background: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top:0; z-index:100; }
        .logo { font-weight: 800; color: var(--red); font-size: 1.4rem; cursor: pointer; }
        #gps-status { font-size: 0.7rem; color: var(--green); font-weight: 700; margin-top: 5px; }

        /* Estilo de las Tarjetas de Pedido */
        .card { background: white; margin: 15px; padding: 20px; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); border: 1px solid #EEE; position: relative; transition: 0.3s; }
        .card.done { opacity: 0.4; filter: grayscale(1); border-left: 6px solid var(--green); }
        
        .client-name { font-size: 1.25rem; font-weight: 700; display: block; margin-bottom: 5px; }
        .client-info { font-size: 0.9rem; color: #666; margin-bottom: 15px; font-family: 'JetBrains Mono', monospace; }
        .price-tag { color: var(--green); background: #EFFFF4; padding: 3px 8px; border-radius: 6px; font-weight: 800; }

        /* Botones de Acci√≥n para el Mensajero */
        .btn-nav { background: var(--blue); color: white; width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 800; font-size: 1rem; margin-bottom: 12px; box-shadow: 0 4px 15px rgba(0,122,255,0.3); }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        button { border-radius: 14px; border: none; font-family: 'Outfit', sans-serif; font-weight: 700; cursor: pointer; transition: 0.2s; }
        
        .btn-move { background: #FFF0F4; color: var(--red); padding: 14px; }
        .btn-wa { background: #25D366; color: white; padding: 14px; }
        .btn-finish { background: var(--red); color: white; width: 100%; padding: 16px; font-weight: 800; font-size: 1rem; }

        /* Panel de Administrador (Oculto) */
        #admin-box { background: #111; color: white; padding: 25px; display: none; margin: 15px; border-radius: 20px; }
        #admin-box h2 { font-size: 1.2rem; margin-bottom: 10px; color: var(--red); }
        textarea { width: 100%; background: #222; border: 1px solid #444; color: #0f0; padding: 10px; border-radius: 10px; margin: 10px 0; font-family: monospace; }
        .btn-gen { background: var(--green); color: white; padding: 15px; width: 100%; border-radius: 10px; font-size: 1rem; }

        /* Resultado del Link */
        #result-link { background: #000; color: #0f0; padding: 15px; border-radius: 10px; margin-top: 15px; font-size: 0.7rem; word-break: break-all; display: none; border: 1px dashed #555; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="accessAdmin()">LLEGA YA ELITE üõµ</div>
    <div id="gps-status">‚óè GPS ACTIVADO</div>
</header>

<div id="admin-box">
    <h2>PANEL DE CONTROL (JEFE)</h2>
    <p style="font-size: 0.8rem; opacity: 0.7;">Pega el JSON aqu√≠ para crear el link del mensajero:</p>
    <textarea id="input-json" rows="6" placeholder='{"clientes": [...] }'></textarea>
    <button class="btn-gen" onclick="generateWorkerLink()">CREAR LINK PARA TRABAJADOR</button>
    <div id="result-link"></div>
</div>

<div id="main-app"></div>

<script>
    let routeData = { clientes: [] };
    let currentPos = { lat: 0, lng: 0 };

    function init() {
        // 1. ¬øViene una ruta nueva en el link?
        const params = new URLSearchParams(window.location.search);
        const encodedData = params.get('ruta');

        if (encodedData) {
            try {
                // Decodificar y guardar en la memoria del celular
                const decoded = JSON.parse(decodeURIComponent(atob(encodedData)));
                routeData.clientes = decoded.clientes || [];
                localStorage.setItem('ly_flota_v2', JSON.stringify(routeData));
                // Limpiar la URL para que quede bonita
                window.history.replaceState({}, document.title, window.location.pathname);
            } catch(e) { alert("Error al procesar el link de ruta."); }
        } else {
            // 2. Si no hay link nuevo, buscar lo que ya estaba guardado
            const saved = localStorage.getItem('ly_flota_v2');
            if(saved) routeData = JSON.parse(saved);
        }

        // Activar GPS real
        navigator.geolocation.watchPosition(p => {
            currentPos = { lat: p.coords.latitude, lng: p.coords.longitude };
            render();
        }, null, {enableHighAccuracy:true});

        render();
    }

    function render() {
        const container = document.getElementById('main-app');
        if(!routeData.clientes.length) {
            container.innerHTML = '<div style="text-align:center;padding:80px 20px;opacity:0.4;">Esperando asignaci√≥n de ruta...</div>';
            return;
        }

        // Ordenar: Pendientes arriba, Entregados abajo
        const list = routeData.clientes.sort((a,b) => (a.estado === 'entregado' ? 1 : -1));

        let html = '';
        list.forEach(c => {
            const done = c.estado === 'entregado';
            html += `
            <div class="card ${done ? 'done' : ''}">
                <span class="client-name">${c.nombre}</span>
                <div class="client-info">
                    TEL: ${c.telefono} | <span class="price-tag">RD$ ${Number(c.cod).toLocaleString()}</span>
                </div>

                <button class="btn-nav" onclick="navigate('${c.lat}', '${c.lng}')">üöÄ NAVEGAR AHORA</button>

                <div class="btn-row">
                    <button class="btn-move" onclick="reRoute(${c.id})">üìç SE MOVI√ì</button>
                    <button class="btn-wa" onclick="window.open('https://wa.me/${c.telefono}')">WHATSAPP</button>
                </div>

                <button class="btn-finish" onclick="markDone(${c.id})">${done ? '‚úì ENTREGADO' : 'MARCAR ENTREGADO'}</button>
            </div>`;
        });
        container.innerHTML = html;
    }

    // --- FUNCIONES DEL MENSAJERO ---
    function navigate(lat, lng) {
        if(!lat || lat === "undefined") return alert("El cliente no tiene ubicaci√≥n.");
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=motorcycle`);
    }

    function reRoute(id) {
        const c = routeData.clientes.find(x => x.id == id);
        const mode = confirm("¬øD√≥nde est√° el cliente?\n\nOK: Estoy frente a √©l (Guardar mi GPS).\nCANCELAR: Pegar coordenadas nuevas.");
        
        if(mode) {
            if(!currentPos.lat) return alert("Buscando se√±al GPS...");
            c.lat = currentPos.lat; c.lng = currentPos.lng;
        } else {
            const raw = prompt("Pega las nuevas coordenadas (ej: 19.30, -70.24):");
            if(raw && raw.includes(',')) {
                const p = raw.split(',');
                c.lat = p[0].trim(); c.lng = p[1].trim();
            }
        }
        updateMemory();
    }

    function markDone(id) {
        routeData.clientes.find(x => x.id == id).estado = 'entregado';
        updateMemory();
    }

    function updateMemory() {
        localStorage.setItem('ly_flota_v2', JSON.stringify(routeData));
        render();
    }

    // --- FUNCIONES DEL JEFE (ADMIN) ---
    function accessAdmin() {
        const pass = prompt("Clave de Jefe:");
        if(pass === "1234") {
            document.getElementById('admin-box').style.display = 'block';
            window.scrollTo(0,0);
        }
    }

    function generateWorkerLink() {
        const json = document.getElementById('input-json').value;
        try {
            JSON.parse(json); // Validar que est√© bien escrito
            const base64 = btoa(encodeURIComponent(json));
            const finalLink = `${window.location.href.split('?')[0]}?ruta=${base64}`;
            
            const res = document.getElementById('result-link');
            res.style.display = 'block';
            res.innerHTML = `<strong>LINK LISTO:</strong><br>${finalLink}<br><br><button onclick="copyLink('${finalLink}')" style="background:#fff; color:#000; padding:5px; border-radius:5px;">COPIAR PARA WHATSAPP</button>`;
        } catch(e) { alert("El c√≥digo JSON est√° mal escrito. Rev√≠salo."); }
    }

    function copyLink(link) {
        navigator.clipboard.writeText(link);
        alert("¬°Link copiado! Ya puedes pegarlo en el WhatsApp del trabajador.");
    }

    init();
</script>
</body>
</html>
